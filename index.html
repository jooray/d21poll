<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, minimum-scale=1.0"
		/>
		<script src="webxdc.js"></script>
		<style>
			html {
				height: 100%;
				background-color: #4158d0;
				background-image: linear-gradient(
					43deg,
					#4158d0 0%,
					#c850c0 46%,
					#ffcc70 100%
				);
			}
			body {
				font-family: sans-serif;
				padding: 2em;
			}
			.page {
				border: 4px solid #3792fc;
				border-radius: 1em;
				margin-left: auto;
				margin-right: auto;
				padding: 1em 2em 2em 2em;
				max-width: 50em;
				background: white;
			}
			input[type="text"] {
				width: 90%;
			}
			a {
				color: #3792fc;
				text-decoration: none;
			}
			a.button {
				color: #fff;
				background: #3792fc;
				padding: 1em;
				border-radius: 1em;
				margin-right: 1em;
			}
			.resultsBar {
				background-color: #3792fc;
			}
		</style>
	</head>

	<body>
		<div id="configurePage" class="page" style="display: block">
			<h2>Configure Your Poll</h2>
			<div id="answers">
				<p>
					<b>Question:</b><br />
					<input type="text" id="configureQuestion" /><br />
					&nbsp;
				</p>
				<p>
					Answer #1:<br />
					<input type="text" id="configureAnswer0" class="answer" />
				</p>
				<p>
					Answer #2:<br />
					<input type="text" id="configureAnswer1" class="answer" />
				</p>
			</div>
			<p>
				<span id="configureHint">Leave unneeded answers fields empty.</span
				><br />
				&nbsp;
			</p>
			<p>
				<a class="button" href="" onclick="addAnswer(); return false;"
					>Add an answer</a
				>
			</p>

			<p>
				<a class="button" href="" onclick="configure(); return false;"
					>Create Poll</a
				>
			</p>
		</div>
		<div id="votePage" class="page" style="display: none">
			<h2 id="voteQuestion">Question</h2>
			<div id="voteCheckboxes">
				<!-- <p id="voteDiv0">
					<input type="checkbox" name="vote" id="voteRadio0" />
					<label id="voteLabel0" for="voteRadio0">Answer</label>
				</p>
				<p id="voteDiv1">
					<input type="checkbox" name="vote" id="voteRadio1" />
					<label id="voteLabel1" for="voteRadio1">Answer</label>
				</p> -->
			</div>
			<p id="voteHint" style="display: none"></p>
			<p>
				<br />
				<a class="button" href="" onclick="vote(); return false;">Vote</a>
				<a href="" onclick="refresh('resultsPage'); return false;"
					>View Results</a
				>
			</p>
		</div>
		<div id="resultsPage" class="page" style="display: none">
			<h2 id="resultsQuestion">Question</h2>
			<div id="resultsDiv0">
				<b id="resultsAnswer0">Answer</b> -
				<span id="resultsVotes0">0 votes</span><br />
				<div class="resultsBar" id="resultsBar0" style="width: 0%">&nbsp;</div>
				<br />
			</div>
			<div id="resultsDiv1">
				<b id="resultsAnswer1">Answer</b> -
				<span id="resultsVotes1">0 votes</span><br />
				<div class="resultsBar" id="resultsBar1" style="width: 0%">&nbsp;</div>
				<br />
			</div>
			<div id="resultsDiv2">
				<b id="resultsAnswer2">Answer</b> -
				<span id="resultsVotes2">0 votes</span><br />
				<div class="resultsBar" id="resultsBar2" style="width: 0%">&nbsp;</div>
				<br />
			</div>
			<div id="resultsDiv3">
				<b id="resultsAnswer3">Answer</b> -
				<span id="resultsVotes3">0 votes</span><br />
				<div class="resultsBar" id="resultsBar3" style="width: 0%">&nbsp;</div>
				<br />
			</div>
			<div id="resultsDiv4">
				<b id="resultsAnswer4">Answer</b> -
				<span id="resultsVotes4">0 votes</span><br />
				<div class="resultsBar" id="resultsBar4" style="width: 0%">&nbsp;</div>
			</div>
			<div><span id="resultsTotalVotes">0</span> people voted</div>
			<p>
				<a href="" onclick="refresh('votePage'); return false;">Your Vote</a>
			</p>
		</div>
		<script>
			// the status is altered by the following updates:
			//
			// {action:"configure", question:"", answers:["", "", "", "", ""]}
			// {action:"vote", sender:"addr", vote:0..4}
			//
			// configure is only executed when there are no votes yet,
			// subsequent votes from the same addr overwrite previous votes.
			let MAX_ANSWERS;
			var globalStatus = {
				people: [],
				question: "",
				answers: [
					{ answer: "", votes: [] },
					{ answer: "", votes: [] },
				],
			};

			function configure() {
				console.log(MAX_ANSWERS);
				// validate input
				if (document.getElementById("configureQuestion").value.trim() === "") {
					document.getElementById("configureHint").innerText =
						"⚠️ Please enter a question.";
					return;
				}
				var answerObjects = document.getElementsByClassName("answer");
				console.log(answerObjects);
				for (let i = 0; i < MAX_ANSWERS; i++) {
					if (answerObjects[i].value.trim() === "") {
						document.getElementById("configureHint").innerText =
							"⚠️ Please enter all the answers.";
						return;
					}
				}

				// change status
				globalStatus.question = document
					.getElementById("configureQuestion")
					.value.trim();
				var j = 0;
				var answers = [];
				for (let i = 0; i < MAX_ANSWERS; i++) {
					if (answerObjects[i].value.trim() !== "") {
						answers[j] = answerObjects[i].value.trim();
						globalStatus.answers[j].answer = answers[j];
						j++;
					}
				}

				// send update
				window.webxdc.sendUpdate(
					{
						payload: {
							action: "configure",
							sender: window.webxdc.selfAddr,
							question: globalStatus.question,
							answers: answers,
						},
						summary: globalStatus.question,
					},
					'Poll "' + globalStatus.question + '" created.'
				);
			}

			function isConfigured() {
				return globalStatus.question.trim() !== "";
			}

			function addAnswer() {
				//push new answer to globalstatus
				globalStatus.answers.push({ answer: "", votes: [] });
				//create new dom answer
				var newAnswer = document.createElement("p");
				newAnswer.textContent = "Answer #" + globalStatus.answers.length + ":";
				newAnswer.appendChild(document.createElement("br"));
				var input = document.createElement("input");
				input.setAttribute("type", "text");
				// input.setAttribute(
				// 	"id",
				// 	"configureAnswer" + (globalStatus.answers.length - 1) + "'"
				// );
				input.classList.add("answer");
				newAnswer.appendChild(input);
				//add new answer to the document
				var answers = document.querySelector("#answers");
				answers.appendChild(newAnswer);
				MAX_ANSWERS = globalStatus.answers.length;
			}

			function vote() {
				// validate input
				var person = window.webxdc.selfAddr;
				var vote = [];
				for (let i = 0; i < MAX_ANSWERS; i++) {
					if (document.getElementById("voteRadio" + i).checked) {
						vote.push(i);
					}
				}
				if (vote.length === 0) {
					document.getElementById("voteHint").innerText =
						"⚠️ Please choose an option.";
					document.getElementById("voteHint").style.display = "block";
					return;
				}

				// change status
				removeVote(window.webxdc.selfAddr);
				for (let i = 0; i < vote.length; i++) {
					globalStatus.answers[vote[i]].votes.push(window.webxdc.selfAddr);
				}

				// send update
				window.webxdc.sendUpdate(
					{
						payload: {
							action: "vote",
							sender: window.webxdc.selfAddr,
							vote: vote,
						},
						summary:
							"" +
							globalStatus.people.length +
							' people voted in "' +
							globalStatus.question +
							'"',
					},
					// 'One vote for "' + globalStatus.answers[vote].answer + '".'
					window.webxdc.selfAddr + " has voted!"
				);
			}

			function hasSelfVoted() {
				var selfAddr = window.webxdc.selfAddr;
				for (let i = 0; i < MAX_ANSWERS; i++) {
					for (let j = 0; j < globalStatus.answers[i].votes.length; j++) {
						if (globalStatus.answers[i].votes[j] === selfAddr) {
							return true;
						}
					}
				}
				return false;
			}

			function removeVote(addr) {
				for (let i = 0; i < MAX_ANSWERS; i++) {
					for (let j = 0; j < globalStatus.answers[i].votes.length; j++) {
						if (globalStatus.answers[i].votes[j] === addr) {
							globalStatus.answers[i].votes.splice(j, 1);
							j--;
							// if(globalStatus.people.indexOf(addr) != -1) globalStatus.people.splice(globalStatus.people.indexOf(addr),1);
						}
					}
				}
			}

			function getTotalVotes() {
				var totalVotes = 0;
				for (let i = 0; i < MAX_ANSWERS; i++) {
					totalVotes += globalStatus.answers[i].votes.length;
				}
				return totalVotes;
			}

			function refresh(page) {
				if (page === "configurePage") {
				} else if (page === "votePage") {
					document.getElementById("configurePage").style.display = "none";
					document.getElementById("resultsPage").style.display = "none";
					document.getElementById("voteQuestion").innerText =
						globalStatus.question;
					document.getElementById("voteHint").style.display = "none";
					// for (let i = 0; i < MAX_ANSWERS; i++) {
					// 	document.getElementById("voteDiv" + i).style.display =
					// 		globalStatus.answers[i].answer === "" ? "none" : "block";
					// 	document.getElementById("voteLabel" + i).innerText =
					// 		globalStatus.answers[i].answer;
					// }

					//create answer checkboxes
				var checkBoxes = document.getElementById("voteCheckboxes");
				for (let i = 0; i < MAX_ANSWERS; i++) {
					var p = document.createElement("p");
					var input = document.createElement("input");
					input.setAttribute("type", "checkbox");
					input.setAttribute("id", "voteRadio"+i);
					p.appendChild(input);
					var label = document.createElement("label");
					label.textContent = globalStatus.answers[i].answer;
					p.appendChild(label);
					checkBoxes.appendChild(p);
					console.log(p);
				}

				} else {
					document.getElementById("configurePage").style.display = "none";
					document.getElementById("votePage").style.display = "none";
					document.getElementById("resultsQuestion").innerText =
						globalStatus.question;
					let totalVotes = getTotalVotes();
					for (let i = 0; i < MAX_ANSWERS; i++) {
						let votes = globalStatus.answers[i].votes.length;
						let percent =
							totalVotes === 0 ? 0 : Math.round((votes * 100) / totalVotes);
						let barWidth = percent === 0 ? "1px" : percent + "%";
						document.getElementById("resultsDiv" + i).style.display =
							globalStatus.answers[i].answer === "" ? "none" : "block";
						document.getElementById("resultsAnswer" + i).innerText =
							globalStatus.answers[i].answer;
						document.getElementById("resultsVotes" + i).innerText =
							votes + (votes === 1 ? " vote (" : " votes (") + percent + "%)";
						document.getElementById("resultsBar" + i).style.width = barWidth;
					}
					document.getElementById("resultsTotalVotes").innerText =
						globalStatus.people.length;
				}
				document.getElementById(page).style.display = "block";
			}

			// main
			window.webxdc.setUpdateListener((update) => {
				if (update.payload.action === "configure") {
					if (!isConfigured()) {
						globalStatus.question = update.payload.question;
						MAX_ANSWERS = update.payload.answers.length;
						for (let i = 0; i < MAX_ANSWERS; i++) {
							globalStatus.answers[i].answer =
								update.payload.answers[i];
						}
					}
				} else if (update.payload.action === "vote") {
					removeVote(update.payload.sender);
					if (globalStatus.people.indexOf(update.payload.sender) == -1)
						globalStatus.people.push(update.payload.sender);

					if (
						update.payload.vote.length >= 1 &&
						update.payload.vote.length <= MAX_ANSWERS
					) {
						for (let i = 0; i < update.payload.vote.length; i++) {
							globalStatus.answers[update.payload.vote[i]].votes.push(
								update.payload.sender
							);
						}
					}
				}

				if (update.serial === update.max_serial) {
					if (!isConfigured()) {
						refresh("configurePage");
					} else if (!hasSelfVoted()) {
						refresh("votePage");
					} else {
						refresh("resultsPage");
					}
				}
			});
		</script>
	</body>
</html>
