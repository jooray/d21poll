<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <script src="deltachat.js"></script>
</head>

<body>
    <div id="configurePage" style="display:none;">
        <h2>Configure Your Poll</h2>
        <p>
            Question:<br>
            <input type="text" id="configureQuestion">
        </p>
        <p>
            Answer #1:<br>
            <input type="text" id="configureAnswer0">
        </p>
        <p>
            Answer #2:<br>
            <input type="text" id="configureAnswer1">
        </p>
        <p>
            Answer #3:<br>
            <input type="text" id="configureAnswer2">
        </p>
        <p>
            Answer #4:<br>
            <input type="text" id="configureAnswer3">
        </p>
        <p>
            Answer #5:<br>
            <input type="text" id="configureAnswer4">
        </p>
        <p>
            <span id="configureHint">Leave unneeded answers fields empty.</span>
        </p>
        <p>
            <a href="" onclick="configure(); return false;">Create Poll</a>
        </p>
    </div>
    <div id="votePage" style="display:none;">
        <h2 id="voteQuestion">Question</h2>
        <p>
            <input type="radio" name="vote" id="voteRadio0"> <label id="voteLabel0" for="voteRadio0">Answer</label>
        </p>
        <p>
            <input type="radio" name="vote" id="voteRadio1"> <label id="voteLabel1" for="voteRadio1">Answer</label>
        </p>
        <p>
            <input type="radio" name="vote" id="voteRadio2"> <label id="voteLabel2" for="voteRadio2">Answer</label>
        </p>
        <p>
            <input type="radio" name="vote" id="voteRadio3"> <label id="voteLabel3" for="voteRadio3">Answer</label>
        </p>
        <p>
            <input type="radio" name="vote" id="voteRadio4"> <label id="voteLabel4" for="voteRadio4">Answer</label>
        </p>
        <p>
            <a href="" onclick="return false;">Vote</a>
        </p>
    </div>
    <div id="resultsPage" style="display:none;">
        <h2>Results</h2>
        <p>
            <b id="resultsAnswer0">Answer</b> - <span id="resultsVotes0">0 votes</span><br>
            <div id="resultsBar0" style="width:30%; background:#888;">&nbsp;</div>
        </p>
        <p>
            <b id="resultsAnswer1">Answer</b> - <span id="resultsVotes1">0 votes</span><br>
            <div id="resultsBar1" style="width:50%; background:#888;">&nbsp;</div>
        </p>
        <p>
            <b id="resultsAnswer2">Answer</b> - <span id="resultsVotes2">0 votes</span><br>
            <div id="resultsBar2" style="width:20%; background:#888;">&nbsp;</div>
        </p>
        <p>
            <b id="resultsAnswer3">Answer</b> - <span id="resultsVotes3">0 votes</span><br>
            <div id="resultsBar3" style="width:0%; background:#888;">&nbsp;</div>
        </p>
        <p>
            <b id="resultsAnswer4">Answer</b> - <span id="resultsVotes4">0 votes</span><br>
            <div id="resultsBar4" style="width:0%; background:#888;">&nbsp;</div>
        </p>
        <p>
            Total Votes: <span id="resultsTotalVotes">0</span>
        </p>
    </div>
    <script>

        // the status is altered by the following events:
        //
        // {"action":"configure", "question":"", "answers":["", "", "", "", ""]}
        // {"action":"vote", "sender":"addr", "vote":0..4}
        //
        // configure is only executed when there are no votes yet,
        // subsequent votes from the same addr overwrite previous votes.
        const MAX_ANSWERS = 5;
        var globalStatus = {
            question: "",
            answers: [
                {answer:"", votes:[]},
                {answer:"", votes:[]},
                {answer:"", votes:[]},
                {answer:"", votes:[]},
                {answer:"", votes:[]},
            ]
        };

        function configure() {
            // validate input
            if (document.getElementById("configureQuestion").value.trim() === "") {
                document.getElementById("configureHint").innerText = "⚠️ Please enter a question.";
                return;
            }
            var answers = 0;
            for (let i = 0; i < MAX_ANSWERS; i++) {
                if (document.getElementById("configureAnswer"+i).value.trim() !== "") {
                    answers++;
                }
            }
            if (answers < 2) {
                document.getElementById("configureHint").innerText = "⚠️ Please enter at least two answers.";
                return;
            }

            // change status
            globalStatus.question = document.getElementById("configureQuestion").value.trim();
            var j = 0;
            for (let i = 0; i < MAX_ANSWERS; i++) {
                if (document.getElementById("configureAnswer"+i).value.trim() !== "") {
                    globalStatus.answers[j++].answer = document.getElementById("configureAnswer"+i).value.trim();
                }
            }

            refresh();
        }

        function isConfigured() {
            return globalStatus.question.trim() !== "";
        }

        function hasSelfVoted() {
            var selfAddr = window.deltachat.selfAddr();
            for (let i = 0; i < MAX_ANSWERS; i++) {
                for (let j = 0; j < globalStatus.answers[i].votes.length; j++) {
                    if (globalStatus.answers[i].votes[j] === selfAddr) {
                        return true;
                    }
                }
            }
            return false;
        }

        function getTotalVotes() {
            var totalVotes = 0;
            for (let i = 0; i < MAX_ANSWERS; i++) {
                totalVotes += globalStatus.answers[i].votes.length;
            }
            return totalVotes;
        }

        function refresh() {
            if (!isConfigured()) {
                document.getElementById("configurePage").style.display = "block";
            } else if (!hasSelfVoted()) {
                document.getElementById("configurePage").style.display = "none";
                document.getElementById("votePage").style.display = "block";
                document.getElementById("resultsPage").style.display = "none";
                document.getElementById("voteQuestion").innerText = globalStatus.question;
                for (let i = 0; i < MAX_ANSWERS; i++) {
                    document.getElementById("voteLabel"+i).innerText = globalStatus.answers[i].answer;
                }
            } else {
                document.getElementById("configurePage").style.display = "none";
                document.getElementById("votePage").style.display = "none";
                document.getElementById("resultsPage").style.display = "block";
                let totalVotes = getTotalVotes();
                for (let i = 0; i < MAX_ANSWERS; i++) {
                    let votes = globalStatus.answers[i].votes.length;
                    let percent = votes*100/totalVotes;
                    document.getElementById("resultsAnswer"+i).innerText = globalStatus.answers[i].answer;
                    document.getElementById("resultsVotes"+i).innerText = votes + (votes===1? " vote (" : " votes (") + percent + "%)";
                    document.getElementById("resultsBar"+i).style.width = percent + "%";
                }
                document.getElementById("resultsTotalVotes").innerText = totalVotes;
            }
        }

        function handleEvent(event) {
            if (event.action === "configure") {
                if (!isConfigured()) {
                    globalStatus.question = event.question;
                    for (let i = 0; i < MAX_ANSWERS; i++) {
                        globalStatus.answers[i].answer = event.answers[i];
                    }
                }
            } else if (event.action === "vote") {
                // TODO: remove all previous votes from sender
                if (event.vote >= 0 && event.vote < MAX_ANSWERS) {
                    globalStatus.answers[event.vote].votes.push(event.sender);
                }
            }
        }

        var allUpdates = window.deltachat.getAllStatusUpdates();
        allUpdates.forEach(handleEvent);

        refresh();

    </script>
</body>

</html>
